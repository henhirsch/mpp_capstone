---
title: "capstone_graphics"
author: "Henry Hirsch"
date: "2024-03-10"
output: html_document
---


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# ```{r setup, include = FALSE}
# knitr::opts_chunk$set(echo = FALSE)
# ```

```{r clear environment}
rm(list=ls())
```

```{r load packages}
library(here)
library(tidyverse)
library(readxl)
library(usmap)
library(scales)
library(fipio)
library(ggrepel)
```

The `i_am` function identifies where the Rmd is located within the main project directory. All future calls to files are based on their relative location to the project root.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# set location of this file in project directory
i_am("code/capstone_graphics.Rmd")

# point to datasets
data_file1 = "data/DMDC_Website_Location_Report_2312_clean.xlsx"
data_file2 = "data/installation_data.xlsx"
data_file3 = "data/median_contract_rent_county_2022.csv"
data_file4 = "data/usa_spending_contracts.csv"
```


```{r load data}
# load data using here
headcount0 <- read_excel(here(data_file1))
master_data0 <- read_excel(here(data_file2), sheet = "Master Data Set (2019)")
median_rent0 <- read.csv(here(data_file3))
demos_2019_0<- read_excel(here(data_file2), sheet = "State Demos (2019)")
demos_2022_0<- read_excel(here(data_file2), sheet = "State Demos (2022)")
contracts0 <- read.csv(here(data_file4))
```


``` {r generate US headcount graphic}
state_headcounts <- headcount0[c(1:4, 7:53), 1:8]
colnames(state_headcounts) <- c("state", "army", "naval", "marines", "air", "space", "coast", "active_duty_total")

us_map_headcount <- plot_usmap(regions = "states", data = state_headcounts, values = "active_duty_total", labels = FALSE) + 
  labs(title = "Active Duty Personnel in the United States",
       subtitle = "Would per capita be more helpful?") + 
  scale_fill_continuous(low = "white", high = "#454B1B", name = "Number of Personnel", label = scales::comma) + 
  theme(panel.background=element_blank(),
        legend.position = "right")
us_map_headcount

```



```{r create master data frame}
# create copy of initial data frame
master_data1 <- master_data0

# make service_branch a factor variable
master_data1$service_branch <- as.factor(master_data1$service_branch)

# add column showing whether headcount is >= 2000
master_data1 <- master_data1 %>%
  mutate(headcount_below_2000 = ifelse(total_sponsors < 2000, "Yes", "No"))

# create latitude and longitude columns from coordinates column
coordinates_split <- strsplit(as.character(master_data1$coordinates), ", ")

latitude <- sapply(coordinates_split, `[`, 1)
longitude <- sapply(coordinates_split, `[`, 2)

master_data1$latitude <- latitude
master_data1$longitude <- longitude

# change order of columns
master_data1 <- master_data1[, c("state", "base", "service_branch", "zip_code", "coordinates", "longitude", "latitude", "nmc", "miles_to_nmc", "headcount_below_2000", "total_sponsors", "total_spouses", "children0-5", "children6-11", "children12-18", "children19andup", "other_dependents", "total_personnel", "family_support_center", "personal_financial_management", "chaplains", "morale_welfare_recreation")]

# remove rows where base = Other
master_data2 <- master_data1[master_data1$base != "Other", ]

# set number of decimal points equal to 6
master_data2$latitude <- format(master_data2$latitude, nsmall = 6)
master_data2$longitude <- format(master_data2$longitude, nsmall = 6)

# make latitude and longitude columns numeric
master_data2$latitude <- as.numeric(master_data2$latitude)
master_data2$longitude <- as.numeric(master_data2$longitude)

# convert coordinates to fips
lon_vector <- master_data2$longitude
lat_vector <- master_data2$latitude

master_data2$fips <- fipio::coords_to_fips(
    x = lon_vector,
    y = lat_vector)

# add 09180 for CT New London Naval Base fips
ct_row_index <- which(master_data2$base == "New London NAVSUBBASE")
master_data2[ct_row_index, "fips"] <- "09180"

# add 08005 for Buckley AFB fip
co_row_index <- which(master_data2$base == "Buckley AFB")
master_data2[co_row_index, "fips"] <- "08005"
```

```{r create median rent data frame}
# rename columns
colnames(median_rent0) <- c("fips", "county", "median_contract_rent", "margin", "X")

# remove first row
median_rent1 <- median_rent0[-1, ]

# remove null rows 
median_rent1 <- median_rent1[median_rent1$margin != "**", ]
median_rent1 <- median_rent1[median_rent1$margin != "***", ]

# remove unneeded columns
median_rent1 <- subset(median_rent1, select = -c(margin, X))

# turn geo_id into county fips codes
median_rent1$fips <- substr(median_rent1$fips, nchar(median_rent1$fips) - 4, nchar(median_rent1$fips))

# convert median_contract_rent column to numeric
median_rent1$median_contract_rent <- as.numeric(median_rent1$median_contract_rent)
```

```{r merge median rent onto master data frame by fips}
master_data2 <- merge(master_data2, median_rent1, by = "fips", all.x = TRUE)

# remove rows with NA values in county column
# master_data2 <- master_data2[!is.na(master_data2$county), ]
```

``` {r transform master data frame coordinates}
# transform values
transformed_data <- usmap_transform(master_data2, input_names = c("longitude", "latitude"), output_names = NULL)
```

``` {r map all military installation headcounts}
# set caption text
installations_caption_text <- paste("Source: The Department of Defense's 2019 Demographics Report. No newer data on military installation headcounts is available. The Department of Defense stopped publishing disaggregated headcount data after 2019.")

# set wrapped caption width
installations_wrapped_caption <- paste(strwrap(installations_caption_text, width = 78), collapse = "\n")

# plot map
all_installations_map <- plot_usmap() +
  geom_sf(
    data = transformed_data,
    aes(size = total_sponsors, color = service_branch),
    alpha = 0.60
  ) +
  labs(title = "Active Duty Personnel on U.S. Military Installations (2019)",
       caption = installations_wrapped_caption) + 
  scale_color_manual(values = c("Navy" = "blue", 
                                 "Army" = "green", 
                                 "Marine Corps" = "red", 
                                 "Air Force" = "orange", 
                                 "DOD" = "purple"),
                     name = "Service Branch") +
  scale_size_continuous(labels = comma, 
                        name = "Installation Headcount") +
  theme(plot.title = element_text(hjust = 0, size = 25),
        legend.position = "left",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -120),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 20, 20, 20))

all_installations_map

# export map
ggsave(here("output", "all_installations_map.jpg"), plot = all_installations_map, width = 12, height = 9, dpi = 300)
```

```{r map military installations with headcount less than 2000}
# create small installations data frame
small_installations <- transformed_data[transformed_data$headcount_below_2000 == "Yes", ]

# plot map
small_installations_map <- plot_usmap() +
  geom_sf(
    data = small_installations,
    aes(size = total_sponsors, color = service_branch),
    alpha = 0.60
  ) +
  labs(title = "Active Duty Personnel on Small U.S. Military Installations (2019)",
       subtitle = "Small installations are defined as those with headcounts below 2,000.",
       caption = installations_wrapped_caption) + 
  scale_color_manual(values = c("Navy" = "blue", 
                                 "Army" = "green", 
                                 "Marine Corps" = "red", 
                                 "Air Force" = "orange", 
                                 "DOD" = "purple"),
                     name = "Service Branch") +
  scale_size_continuous(labels = comma, 
                        name = "Installation Headcount") +
  theme(plot.title = element_text(hjust = 0, size = 25),
        legend.position = "left",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -120),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 20, 20, 20))

small_installations_map

# export map
ggsave(here("output", "small_installations_map.jpg"), plot = small_installations_map, width = 12, height = 9, dpi = 300)
```


```{r create map of median contract rent by county for 2022}
# set subtitle
rent_subtitle_text <- "The American Community Survey defines contract rent as the monthly rent agreed to or contracted for, regardless of any furnishings, utilities, fees, meals, or services that may be included."

wrapped_rent_subtitle <- str_wrap(rent_subtitle_text, width = 100)

# set caption 
rent_caption_text <- paste("Source: The U.S. Census Bureau's American Community Survey, 5-Year Data (2009-2022)")

# set wrapped caption width
rent_wrapped_caption <- paste(strwrap(rent_caption_text, width = 45), collapse = "\n")


# plot rent map
rent_map <- plot_usmap(regions = "counties", data = median_rent1, values = "median_contract_rent", labels = FALSE) + 
  labs(title = "Median Contract Rent by County (2022)",
       subtitle = wrapped_rent_subtitle,
       caption = rent_wrapped_caption) + 
  scale_fill_continuous(low = "yellow", high = "red", name = "Median Contract Rent", label = scales::dollar_format()) + 
theme(plot.title = element_text(hjust = 0, size = 25),
        legend.position = "left",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -130),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 20, 20, 20))

rent_map

# export map
ggsave(here("output", "rent_map.jpg"), plot = rent_map, width = 12, height = 9, dpi = 300)

```


```{r create demographic changes data frame}
# create duplicate data frames
demos_2019_1 <- demos_2019_0
demos_2022_1 <- demos_2022_0

# add years to column names for both data frames
colnames(demos_2019_1) <- c("state", "total_sponsors_2019", "total_spouses_2019", "children0-5_2019", "children6-11_2019", "children12-18_2019", "children19-22_2019", "adult_dependents_2019", "total_dependents_2019", "total_personnel_2019")

colnames(demos_2022_1) <- c("state", "total_sponsors_2022", "total_spouses_2022", "children0-5_2022", "children6-11_2022", "children12-18_2022", "children19-22_2022", "adult_dependents_2022", "total_dependents_2022", "total_personnel_2022")

# create total_children columns
demos_2019_1$total_children_2019 <- rowSums(demos_2019_1[, c("children0-5_2019", "children6-11_2019", "children12-18_2019", "children19-22_2019")], na.rm = TRUE)

demos_2022_1$total_children_2022 <- rowSums(demos_2022_1[, c("children0-5_2022", "children6-11_2022", "children12-18_2022", "children19-22_2022")], na.rm = TRUE)


# merge both data frames
demos_change <- merge(demos_2019_1, demos_2022_1, by = "state", all = TRUE)

# create state abbreviation column
state_abbreviations <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DC", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")

demos_change <- cbind(demos_change[, 1], state_abbreviations, demos_change[, -1])

# fix column names
colnames(demos_change) <- c("state", "state_abbr", "total_sponsors_2019", "total_spouses_2019", "children0-5_2019", "children6-11_2019", "children12-18_2019", "children19-22_2019", "adult_dependents_2019", "total_dependents_2019", "total_personnel_2019", "total_children_2019", "total_sponsors_2022", "total_spouses_2022", "children0-5_2022", "children6-11_2022", "children12-18_2022", "children19-22_2022", "adult_dependents_2022", "total_dependents_2022", "total_personnel_2022", "total_children_2022")

# create change columns
demos_change$change_total_sponsors <- demos_change$total_sponsors_2022 - demos_change$total_sponsors_2019
demos_change$change_total_spouses <- demos_change$total_spouses_2022 - demos_change$total_spouses_2019
demos_change$change_total_children <- demos_change$total_children_2022 - demos_change$total_children_2019
demos_change$change_total_adult_dependents <- demos_change$adult_dependents_2022 - demos_change$adult_dependents_2019
demos_change$change_total_dependents <- demos_change$total_dependents_2022 - demos_change$total_dependents_2019
demos_change$change_total_personnel <- demos_change$total_personnel_2022 - demos_change$total_personnel_2019

# create percent change columns
demos_change$per_change_total_sponsors <- demos_change$change_total_sponsors / demos_change$total_sponsors_2019 * 100
demos_change$per_change_total_spouses <- demos_change$change_total_spouses / demos_change$total_spouses_2019 * 100
demos_change$per_change_total_children <- demos_change$change_total_children / demos_change$total_children_2019 * 100
demos_change$per_change_total_adult_dependents <- demos_change$change_total_adult_dependents / demos_change$adult_dependents_2019 * 100
demos_change$per_change_total_dependents <- demos_change$change_total_dependents / demos_change$total_dependents_2019 * 100
demos_change$per_change_total_personnel <- demos_change$change_total_personnel / demos_change$total_personnel_2019 * 100


# create only changes demographic data frame
only_demos_change <- demos_change[, c("state_abbr", "per_change_total_sponsors", "per_change_total_spouses", "per_change_total_children", "per_change_total_adult_dependents")]

# create long data frame
only_demos_change_long <- pivot_longer(only_demos_change, 
                            cols = c(per_change_total_sponsors, per_change_total_spouses, per_change_total_children, per_change_total_adult_dependents), 
                            names_to = "demo_group",               
                            values_to = "percent_change")

# remove NA values
only_demos_change_long <- only_demos_change_long[!is.na(only_demos_change_long$percent_change), ]

```

```{r graph comparison between 2019 and 2022 state demographics}
# set caption 
demo_caption_text <- paste("Sources: The Department of Defense's 2019 and 2022 Demographics Reports")

# set wrapped caption width
demo_wrapped_caption <- paste(strwrap(demo_caption_text, width = 40), collapse = "\n")

demo_change_plot <- ggplot(only_demos_change_long, aes(fill = demo_group, y = percent_change, x = state_abbr)) + 
  geom_bar(position="stack", stat="identity") +
  theme_minimal() + 
  ggtitle("Percent Change in Personnel Demographics by State (2019 - 2022)") +
  labs(fill = "Demographic Group",
       caption = demo_wrapped_caption) +
  ylab("Percent Change in Personnel") + 
  xlab("State") +
  scale_fill_manual(values = c("per_change_total_sponsors" = "red", "per_change_total_spouses" = "blue", "per_change_total_children" = "purple", "per_change_total_adult_dependents" = "orange"),  # Specify colors and labels
                    labels = c("per_change_total_sponsors" = "Active Duty", "per_change_total_spouses" = "Spouses", "per_change_total_children" = "Children", "per_change_total_adult_dependents" = "Adult Dependents")) +
  theme(plot.title = element_text(hjust = 0, size = 25),
        axis.title.x = element_text(vjust = -2, size = 11),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 8),
        legend.position = "right",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -10),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 30, 20, 20),
        plot.caption = element_text(hjust = 1.2))
   
demo_change_plot

# export bar plot
ggsave(here("output", "demographic_change_bar.jpg"), plot = demo_change_plot, width = 12, height = 9, dpi = 300)
```

```{r map all installations color coded by rent}

# set caption text
installations_rent_caption_text <- paste("Sources: The Department of Defense's 2019 Demographics Report and the U.S. Census Bureau's American Community Survey, 5-Year Data (2009-2022)")

# set wrapped caption width
installations_rent_wrapped_caption <- paste(strwrap(installations_rent_caption_text, width = 78), collapse = "\n")

# plot map
all_installations_rent_map <- plot_usmap() +
  geom_sf(
    data = transformed_data,
    aes(size = total_sponsors, color = median_contract_rent),
    alpha = 0.60
  ) +
  labs(title = "Median Contract Rent Around U.S. Military Installations (2022)",
       subtitle = "Installation headcount data is from 2019. County-level rental data is from 2022.",
       caption = installations_rent_wrapped_caption) + 
  scale_color_continuous(name = "Median Contract Rent",
                         label = scales::dollar_format(),
                         low = "yellow", high = "red") +
  scale_size_continuous(labels = comma, 
                        name = "Installation Headcount") +
  theme(plot.title = element_text(hjust = 0, size = 25),
        legend.position = "left",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -120),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 20, 20, 20))

all_installations_rent_map

# export bar plot
ggsave(here("output", "all_installations_rent_map.jpg"), plot = all_installations_rent_map, width = 12, height = 9, dpi = 300)
    
```


```{r map small installations color coded by rent}
# plot map
small_installations_rent_map <- plot_usmap() +
  geom_sf(
    data = small_installations,
    aes(size = total_sponsors, color = median_contract_rent),
    alpha = 0.60
  ) +
  labs(title = "Median Contract Rent Around Small U.S. Military Installations (2022)",
       subtitle = "Installation headcount data is from 2019. County-level rental data is from 2022.",
       caption = installations_rent_wrapped_caption) + 
  scale_color_continuous(name = "Median Contract Rent",
                         label = scales::dollar_format(),
                         low = "yellow", high = "red") +
  scale_size_continuous(labels = comma, 
                        name = "Installation Headcount") +
  theme(plot.title = element_text(hjust = 0, size = 25),
        legend.position = "left",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -120),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 20, 20, 20))

small_installations_rent_map

# export bar plot
ggsave(here("output", "small_installations_rent_map.jpg"), plot = small_installations_rent_map, width = 12, height = 9, dpi = 300)
```

``` {r arrange data frames by cost of living and export as csvs}
# arrange by descending median contract rent
transformed_data <- arrange(transformed_data, desc(median_contract_rent))
small_installations <- arrange(small_installations, desc(median_contract_rent))

# export as csv or xlsx? (still need to set save location to output folder)
#write.csv(transformed_data, "all_installations.csv", row.names = FALSE)
#write.csv(small_installations, "small_installations.csv", row.names = FALSE)
```

``` {r create data frames for top candidate installations}
# filter by presence and absence of services
all_installation_candidates <- transformed_data[transformed_data$personal_financial_management == "NO" & (transformed_data$chaplains == "YES" | transformed_data$family_support_center == "YES" | transformed_data$morale_welfare_recreation == "YES"), ]

small_installation_candidates <- small_installations[small_installations$personal_financial_management == "NO" & (small_installations$chaplains == "YES" | small_installations$family_support_center == "YES" | small_installations$morale_welfare_recreation == "YES"), ]

# remove NA rows
all_installation_candidates <- all_installation_candidates[!is.na(all_installation_candidates$family_support_center), ]
small_installation_candidates <- small_installation_candidates[!is.na(small_installation_candidates$family_support_center), ]
```

``` {r ^ do the same as above for just installations with no personal financial management services}
# filter by presence and absence of services
all_installation_candidates2 <- transformed_data[transformed_data$personal_financial_management == "NO", ]

small_installation_candidates2 <- small_installations[small_installations$personal_financial_management == "NO", ]
```


```{r map top candidates for all installations}
# set caption text
installation_candidates_caption_text <- paste("placeholder")

# set wrapped caption width
installation_candidates_wrapped_caption <- paste(strwrap(installation_candidates_caption_text, width = 78), collapse = "\n")

# plot map
all_installation_candidates_map <- plot_usmap() +
  geom_sf(
    data = all_installation_candidates2,
    aes(size = total_sponsors, color = service_branch),
    alpha = 0.60
  ) +
  geom_label_repel(data = all_installation_candidates2,
                            aes(label = base, geometry = geometry),
                            size = 3, alpha = 0.8,
                            label.r = unit(0.5, "lines"), label.size = 0.5,
                            segment.color = "red", segment.size = 1,
                            stat = "sf_coordinates", seed = 1002,
                            max.overlaps = 20) +
  labs(title = "placeholder",
       caption = installation_candidates_wrapped_caption) + 
  scale_color_manual(values = c("Navy" = "blue", 
                                 "Army" = "green", 
                                 "Marine Corps" = "red", 
                                 "Air Force" = "orange", 
                                 "DOD" = "purple"),
                     name = "Service Branch") +
  scale_size_continuous(labels = comma, 
                        name = "Installation Headcount") +
  theme(plot.title = element_text(hjust = 0, size = 25),
        legend.position = "left",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -120),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 20, 20, 20))

all_installation_candidates_map

# export map
ggsave(here("output", "all_installation_candidates_map.jpg"), plot = all_installation_candidates_map, width = 12, height = 9, dpi = 300)

```


```{r clean contracts data}
# duplicate data frame
contracts1 <- contracts0

# select columns
contracts1 <- contracts1[, c("parent_award_agency_name", "total_obligated_amount", "current_total_value_of_award", "potential_total_value_of_award", "award_base_action_date_fiscal_year", "award_latest_action_date_fiscal_year", "awarding_agency_name", "awarding_sub_agency_name", "awarding_office_name", "funding_agency_name", "funding_sub_agency_name", "funding_office_name", "object_classes_funding_this_award", "recipient_name", "recipient_name_raw", "recipient_parent_name", "recipient_parent_name_raw", "prime_award_summary_place_of_performance_county_fips_code", "primary_place_of_performance_county_name", "prime_award_summary_place_of_performance_state_fips_code", "primary_place_of_performance_state_code", "primary_place_of_performance_state_name", "product_or_service_code_description", "naics_code", "naics_description", "extent_competed")]

# convert to integer columns
contracts1[, c("total_obligated_amount", "current_total_value_of_award", "potential_total_value_of_award")] <- lapply(contracts1[, c("total_obligated_amount", "current_total_value_of_award", "potential_total_value_of_award")], as.integer)

# define the breakpoints for the categories
contract_breaks <- c(0, 1e6, 25e6, 100e6, 500e6, Inf)

# define labels for the categories
contract_labels <- c("$1,000,000 & Under",
            "$1,000,001 - $25,000,000",
            "$25,000,001 - $100,000,000",
            "$100,000,001 - $500,000,000",
            "$500,000,001 & Above")

# create a new column with group identifiers
contracts1$contract_group <- cut(contracts1$total_obligated_amount, breaks = contract_breaks, labels = contract_labels, include.lowest = TRUE)

# select columns for stacked bar graph
contracts2 <- contracts1[, c("total_obligated_amount", "current_total_value_of_award", "potential_total_value_of_award", "award_base_action_date_fiscal_year", "contract_group")]

# remove NA values
contracts2 <- contracts2[!is.na(contracts2$contract_group), ]
```

```{r create contracts stacked bar graph}
# contracts_bar <- ggplot(contracts2, aes(x = award_base_action_date_fiscal_year, y = potential_total_value_of_award, fill = contract_group)) +
#   geom_bar(stat = "identity") +
#   labs(title = "Stacked Bar Plot of Award Amount by Year and Group",
#        x = "Year",
#        y = "Award Amount",
#        fill = "Groups") +
#   theme_minimal()
# contracts_bar

# set caption 
demo_caption_text <- paste("Sources: The Department of Defense's 2019 and 2022 Demographics Reports")

# set wrapped caption width
demo_wrapped_caption <- paste(strwrap(demo_caption_text, width = 40), collapse = "\n")

contracts_bar <- ggplot(contracts2, aes(x = award_base_action_date_fiscal_year, y = total_obligated_amount, fill = contract_group)) + 
  geom_bar(position="stack", stat="identity") +
  theme_minimal() + 
  ggtitle("Percent Change in Personnel Demographics by State (2019 - 2022)") +
  labs(fill = "Demographic Group",
       caption = demo_wrapped_caption) +
  ylab("Percent Change in Personnel") + 
  xlab("State") +
  scale_fill_manual(values = c(
            "$1,000,000 & Under" = "#cbc9e2",
            "$1,000,001 - $25,000,000" = "#9e9ac8",
            "$25,000,001 - $100,000,000" = "#756bb1",
            "$100,000,001 - $500,000,000" = "#54278f",
            "$500,000,001 & Above" = "purple")) +
  theme(plot.title = element_text(hjust = 0, size = 25),
        axis.title.x = element_text(vjust = -2, size = 11),
        axis.title.y = element_text(size = 11),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 8),
        legend.position = "right",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.justification = "right",
        legend.spacing = unit(0.5, "cm"),
        legend.margin = margin(r = -10),
        legend.title = element_text(size = 11),
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "lines"),
        plot.margin = margin(20, 30, 20, 20),
        plot.caption = element_text(hjust = 1.2))

contracts_bar
```